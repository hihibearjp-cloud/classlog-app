<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <!-- è®“ iPhone / iPad å¯ä»¥ã€ŒåŠ å…¥ä¸»ç•«é¢ã€æˆç‚º APP -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="ç­ç´šå°ç®¡å®¶">

<!-- App Iconï¼ˆä½ å¯ä»¥æ›æˆè‡ªå·±çš„ icon.pngï¼‰-->
<link rel="apple-touch-icon" href="icon.png">

<!-- è®“æ‰‹æ©Ÿä¸æœƒç¸®æ”¾æˆ–äº‚æ‰ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç­ç´šå°ç®¡å®¶1.0ç‰ˆ</title>
  <meta name="theme-color" content="#FEF9F2" />
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
  <style>
    :root{--coffee:#5D4037;--bg:#FEF9F2}
    *{box-sizing:border-box}
    body{font-family:'ZCOOL KuaiLe',sans-serif;background:var(--bg);color:var(--coffee);margin:0;padding:16px;min-height:100vh}
    .container{max-width:900px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px}
    h1{margin:0;font-size:1.4rem}
    .card{background:#fff;border:3px solid var(--coffee);border-radius:12px;padding:12px;margin-top:12px;box-shadow:4px 4px 0 rgba(0,0,0,0.04)}
    .row{display:flex;gap:8px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .btn{border:3px solid var(--coffee);padding:8px 12px;border-radius:12px;background:#fff;cursor:pointer;font-weight:700}
    .btn.big{padding:12px 16px;font-size:1rem}
    .btn.primary{background:#CDF0EA}
    .btn.warn{background:#FDFD96}
    .badge{background:var(--coffee);color:#fff;padding:4px 8px;border-radius:999px;font-weight:800}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px}
    .student{border:2px dashed #ccc;border-radius:8px;padding:6px;background:#fff;display:flex;justify-content:space-between;align-items:center}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal .box{background:#fff;padding:12px;border-radius:12px;width:100%;max-width:520px;max-height:85vh;overflow:auto;border:3px solid var(--coffee)}
    .list-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    textarea,input,select{width:100%;padding:8px;border:2px solid var(--coffee);border-radius:8px}
    .small{font-size:0.85rem}
    footer{margin-top:24px;font-size:0.8rem;color:#666}
    @media(max-width:600px){ .list-grid{grid-template-columns:repeat(3,1fr)} h1{font-size:1.1rem} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>ğŸ“š ç­ç´šå°ç®¡å®¶ï¼ˆç°¡æ˜“ç‰ˆï¼‰</h1>
        <div class="small" id="subtitle"></div>
      </div>
      <div class="row">
        <button class="btn" id="backupBtn">å‚™ä»½ JSON</button>
        <input id="restoreFile" type="file" accept=".json" style="display:none">
        <button class="btn" id="restoreBtn">é‚„åŸ JSON</button>
      </div>
    </header>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div style="flex:1;max-width:360px">
          <label class="small">æ—¥æœŸ</label>
          <input type="date" id="dateInput" />
        </div>
        <div style="flex:1;max-width:240px">
          <label class="small">é€±æ¬¡ / å€¼æ—¥</label>
          <input id="weekInput" placeholder="ä¾‹ï¼š2é€± / å¹¹éƒ¨: ç‹å°æ˜" />
        </div>
        <div style="flex-basis:180px;text-align:right">
          <label class="small">&nbsp;</label><br/>
          <button class="btn big" id="exportCsvBtn">åŒ¯å‡ºä»Šæ—¥ CSV</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>ğŸ”” åˆ°æ ¡ç‹€æ³</h3>
      <div class="grid" id="attendanceBtns"></div>
    </div>

    <div class="card">
      <h3>ğŸ“˜ ä½œæ¥­ / è¯çµ¡ç°¿</h3>
      <div class="row wrap" id="missingBtns"></div>
      <div style="margin-top:8px">
        <label class="small">ç§‘ç›®åˆ—è¡¨ï¼ˆä¸€è¡Œä¸€å€‹ï¼ŒæŒ‰ä¸‹ã€ŒåŒ¯å…¥åå–®ã€æœƒå–ä»£å­¸ç”Ÿåå–®ï¼‰</label>
        <textarea id="bulkSubject" rows="3" placeholder="åœ‹æ–‡&#10;æ•¸å­¸"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="addSubjectBtn">æ–°å¢ç§‘ç›®</button>
          <button class="btn" id="resetSubjectsBtn">é‡ç½®é è¨­ç§‘ç›®</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>ğŸ‘¥ å­¸ç”Ÿåå–®</h3>
        <div class="row">
          <button class="btn" id="bulkImportBtn">æ‰¹æ¬¡åŒ¯å…¥å§“å</button>
          <button class="btn" id="resetStudentsBtn">æ¢å¾©é è¨­ (30 äºº)</button>
        </div>
      </div>

      <div style="margin-top:8px" id="studentsContainer"></div>
    </div>

    <footer>
      æç¤ºï¼šæŠŠæ•´å€‹æª”æ¡ˆä¸Šå‚³åˆ° GitHubï¼Œå‘½åç‚º <code>index.html</code>ï¼Œç„¶å¾Œå•Ÿç”¨ GitHub Pagesï¼ˆbranchï¼šmain / rootï¼‰ã€‚
    </footer>
  </div>

  <!-- Modalï¼ˆå‹•æ…‹å»ºç«‹ï¼‰ -->
  <div id="modalRoot"></div>

  <script>
    /***********************
     * è³‡æ–™èˆ‡é è¨­å€¼
     ***********************/
    const DB_KEY = 'classlog_simple_v1';
    const DEFAULT_SUBJECTS = ['åœ‹æ–‡','è‹±èª','æ•¸å­¸','ç†åŒ–','ç¤¾æœƒ'];
    const ATTENDANCE_TYPES = [
      { id:'late', label:'é²åˆ°', color:'#FDFD96' },
      { id:'sick', label:'ç—…å‡', color:'#CDF0EA' },
      { id:'official', label:'å…¬å‡', color:'#C4E4FF' },
      { id:'personal', label:'äº‹å‡', color:'#E2C4FF' },
      { id:'absent', label:'ç¼ºå¸­', color:'#FFC4C4' }
    ];
    let state = {
      date: null,
      week: '',
      students: Array.from({length:30}, (_,i)=>({id:i+1,name:`${i+1}è™Ÿ`})),
      subjects: [...DEFAULT_SUBJECTS],
      attendance: {}, // { date: { typeId: [ids] } } but we'll keep only today's
      missing: {}, // { subjectId: [ids] }
    };

    /***********************
     * UI å¿«é€Ÿ helpers
     ***********************/
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, props={}, ...children)=>{ const d=document.createElement(tag); for(const k in props){ if(k==='style') Object.assign(d.style,props[k]); else if(k.startsWith('on')) d.addEventListener(k.slice(2),props[k]); else d.setAttribute(k,props[k]); } children.forEach(c=>{ if(typeof c==='string') d.appendChild(document.createTextNode(c)); else if(c) d.appendChild(c); }); return d; }

    /***********************
     * åˆå§‹åŒ–èˆ‡å„²å­˜
     ***********************/
    function loadState(){
      try{
        const raw = localStorage.getItem(DB_KEY);
        if(raw){ const s = JSON.parse(raw); state = {...state, ...s}; }
      }catch(e){ console.error(e); }
      // date default today (ISO yyyy-mm-dd)
      if(!state.date){
        const now=new Date(); const off=now.getTimezoneOffset()*60000; state.date=new Date(now.getTime()-off).toISOString().split('T')[0];
      }
    }
    function saveState(){ localStorage.setItem(DB_KEY, JSON.stringify(state)); render(); }

    /***********************
     * Render functions
     ***********************/
    function render(){
      $('#dateInput').value = state.date;
      $('#weekInput').value = state.week || '';
      $('#subtitle').textContent = `${state.date}`;

      // attendance buttons
      const attRoot = $('#attendanceBtns'); attRoot.innerHTML='';
      ATTENDANCE_TYPES.forEach(t => {
        const count = (state.attendance[t.id]||[]).length;
        const b = el('button',{class:'btn', style:{background:t.color,display:'flex',justifyContent:'space-between',alignItems:'center'}, onClick:()=>openSelector('attendance', t.id, t.label)}, el('span',{},t.label), el('span',{class:'badge'}, count));
        attRoot.appendChild(b);
      });

      // missing buttons
      const missingRoot = $('#missingBtns'); missingRoot.innerHTML='';
      const contactTypes = ['è¯çµ¡ç°¿ç¼ºäº¤','å®¶é•·æœªç°½å','è¯çµ¡ç°¿å„ªè‰¯'];
      contactTypes.concat(state.subjects).forEach((label,idx)=>{
        const id = 'm_'+idx;
        const count = (state.missing[id]||[]).length;
        const b = el('button',{class:'btn', style:{background:'#fff'}, onClick:()=>openSelector('missing', id, label)}, label, el('span',{class:'badge', style:{marginLeft:8}}, count));
        missingRoot.appendChild(b);
      });

      // students list
      const sc = $('#studentsContainer'); sc.innerHTML='';
      const box = el('div',{});
      state.students.forEach(s=>{
        const row = el('div',{class:'student', style:{marginBottom:'6px'}},
          el('div',{}, `${s.id}. ${s.name}`),
          el('div',{}, el('button',{class:'btn', onClick:()=>editStudentName(s.id)}, 'ç·¨è¼¯'))
        );
        sc.appendChild(row);
      });
    }

    /***********************
     * æ“ä½œ UI
     ***********************/
    function openSelector(type, key, label){
      // type: 'attendance' or 'missing'
      const modalRoot = $('#modalRoot'); modalRoot.innerHTML='';
      const box = el('div',{class:'modal'},
        el('div',{class:'box'},
          el('div',{}, el('strong',{}, `${label}`), el('span',{style:{float:'right'}}, el('button',{class:'btn', onClick:closeModal}, 'å®Œæˆ')) ),
          el('div',{style:{height:12}}),
          el('div',{class:'list-grid'},
            ...state.students.map(s=>{
              const selected = (type==='attendance' ? (state.attendance[key]||[]) : (state.missing[key]||[])).includes(s.id);
              return el('button',{class:'btn', style:{background:selected?'#5D4037':'#fff',color:selected?'#fff':'inherit'}, onClick:()=>toggleMark(type,key,s.id)}, `${s.id}. ${s.name}` );
            })
          )
        )
      );
      modalRoot.appendChild(box);
      function closeModal(){ modalRoot.innerHTML=''; saveState(); }
    }

    function closeModal(){ $('#modalRoot').innerHTML=''; }

    function toggleMark(type, key, studentId){
      if(type==='attendance'){
        const arr = state.attendance[key]||[];
        if(arr.includes(studentId)) state.attendance[key]=arr.filter(x=>x!==studentId);
        else state.attendance[key]=[...arr,studentId];
      } else {
        const arr = state.missing[key]||[];
        if(arr.includes(studentId)) state.missing[key]=arr.filter(x=>x!==studentId);
        else state.missing[key]=[...arr,studentId];
      }
      render();
    }

    function editStudentName(id){
      const s = state.students.find(x=>x.id===id);
      const newName = prompt('ä¿®æ”¹å­¸ç”Ÿåç¨±', s.name);
      if(newName!==null){ s.name = newName.trim()||s.name; saveState(); }
    }

    /***********************
     * åŒ¯å‡º CSV / å‚™ä»½ é‚„åŸ
     ***********************/
    function exportTodayCSV(){
      const date = state.date;
      let csv = `ç­ç´šæ—¥èªŒ,æ—¥æœŸ,${date}\n\n`;
      csv += 'é¡åˆ¥,é …ç›®,å­¸ç”Ÿ\n';
      for(const t of ATTENDANCE_TYPES){
        const list = (state.attendance[t.id]||[]).map(id=>state.students.find(s=>s.id===id)?.name||id).join('ã€');
        if(list) csv += `åˆ°æ ¡,${t.label},"${list}"\n`;
      }
      csv += '\nä½œæ¥­ç¼ºäº¤\n';
      Object.keys(state.missing).forEach(k=>{
        if(state.missing[k] && state.missing[k].length>0){
          const label = k.startsWith('m_') ? (k==='m_0' ? 'è¯çµ¡ç°¿ç¼ºäº¤' : (k==='m_1' ? 'å®¶é•·æœªç°½å' : (k==='m_2' ? 'è¯çµ¡ç°¿å„ªè‰¯' : state.subjects[Number(k.split('_')[1]) - 3] || k))) : k;
          const names = state.missing[k].map(id=>state.students.find(s=>s.id===id)?.name||id).join('ã€');
          csv += `${label},ç¼ºäº¤,"${names}"\n`;
        }
      });

      const blob = new Blob([`\uFEFF${csv}`], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ç­ç´šæ—¥èªŒ_${date}.csv`; a.click();
    }

    function backupJSON(){
      const payload = { version:'simple_v1', timestamp:new Date().toISOString(), data:state };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `classlog_backup_${state.date}.json`; a.click();
    }

    function restoreFromFile(file){
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const payload = JSON.parse(e.target.result);
          if(payload && payload.data){
            state = {...state, ...payload.data};
            saveState();
            alert('é‚„åŸæˆåŠŸ');
          } else alert('æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º');
        }catch(err){ alert('è®€å–å¤±æ•—'); }
      };
      reader.readAsText(file);
    }

    /***********************
     * äº‹ä»¶ç¶å®š
     ***********************/
    document.addEventListener('DOMContentLoaded', ()=>{
      loadState();

      // date change
      $('#dateInput').addEventListener('change', (e)=>{ state.date = e.target.value; saveState(); });
      $('#weekInput').addEventListener('input', (e)=>{ state.week = e.target.value; saveState(); });

      // students area buttons
      $('#bulkImportBtn').addEventListener('click', ()=>{
        const txt = prompt('è«‹è²¼ä¸Šå­¸ç”Ÿåå­—ï¼Œæ¯è¡Œä¸€å€‹ï¼Œå°‡å–ä»£ç¾æœ‰åå–®', state.students.map(s=>s.name).join('\\n'));
        if(txt!==null){
          const names = txt.split('\\n').map(s=>s.trim()).filter(Boolean);
          if(names.length>0){ state.students = names.map((n,i)=>({id:i+1,name:n})); saveState(); }
        }
      });
      $('#resetStudentsBtn').addEventListener('click', ()=>{
        if(confirm('è¦æ¢å¾©ç‚º 30 äººé è¨­åå–®å—ï¼Ÿ')){ state.students = Array.from({length:30}, (_,i)=>({id:i+1,name:`${i+1}è™Ÿ`})); saveState(); }
      });

      // subjects
      $('#addSubjectBtn').addEventListener('click', ()=>{
        const s = $('#bulkSubject').value.trim();
        if(s){ const lines = s.split('\\n').map(x=>x.trim()).filter(Boolean); state.subjects = [...state.subjects, ...lines]; $('#bulkSubject').value=''; saveState(); }
      });
      $('#resetSubjectsBtn').addEventListener('click', ()=>{ state.subjects = [...DEFAULT_SUBJECTS]; saveState(); });

      // export csv
      $('#exportCsvBtn').addEventListener('click', ()=>exportTodayCSV());

      // backup / restore
      $('#backupBtn').addEventListener('click', ()=>backupJSON());
      $('#restoreBtn').addEventListener('click', ()=>$('#restoreFile').click());
      $('#restoreFile').addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) restoreFromFile(f); e.target.value=''; });

      // initial render
      render();
    });
  </script>
</body>
</html>
